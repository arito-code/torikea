<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 24px;
        background: #e8f5e9; /* ã‚„ã•ã—ã„é»„ç·‘ */
      }
      .container {
        max-width: 840px;
        margin: 0 auto;
        background: #ffffff;
        padding: 24px 32px 30px;
        border-radius: 18px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        border: 2px solid #c8e6c9;
        position: relative;
      }
      h1 {
        font-size: 26px;
        margin: 0 0 4px;
        text-align: center;
        color: #1b5e20;
      }
      .subtitle {
        text-align: center;
        font-size: 14px;
        color: #4e6e4f;
        margin-bottom: 20px;
      }
      p {
        font-size: 15px;
        line-height: 1.7;
      }
      .top-right-btn {
        position: absolute;
        top: 16px;
        right: 16px;
      }
      .top-right-btn .btn-small {
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid #a5d6a7;
        background: #ffffff;
        color: #2e7d32;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .top-right-btn .btn-small:hover {
        background: #e8f5e9;
      }

      .step {
        margin: 18px 0;
        padding: 16px 18px 18px;
        border-radius: 14px;
        background: #f1f8e9;
        border: 1px solid #c5e1a5;
        display: flex;
        gap: 14px;
        align-items: flex-start;
      }
      .step-badge {
        min-width: 42px;
        height: 42px;
        border-radius: 50%;
        background: #66bb6a;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .step-content {
        flex: 1;
      }
      .step-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 6px;
        color: #2e7d32;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 16px;
        padding: 12px 22px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        margin: 6px 0;
        min-width: 280px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background 0.1s;
      }
      .btn span.icon {
        font-size: 18px;
      }
      .btn-primary {
        background: #43a047;
        color: #ffffff;
      }
      .btn-primary:hover:not(:disabled) {
        background: #2e7d32;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.18);
      }
      .btn-secondary {
        background: #ffffff;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
      }
      .btn-secondary:hover:not(:disabled) {
        background: #e8f5e9;
        transform: translateY(-1px);
      }
      .btn-link {
        background: #ffffff;
        border: 1px solid #cfd8dc;
        color: #37474f;
      }
      .btn-link:hover:not(:disabled) {
        background: #eceff1;
        transform: translateY(-1px);
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }
      #fileInput {
        margin-top: 8px;
        font-size: 14px;
      }
      #status {
        margin-top: 18px;
        min-height: 26px;
        font-size: 14px;
        padding: 8px 10px;
        border-radius: 8px;
      }
      #status.ok {
        color: #1b5e20;
        background: #e8f5e9;
        border: 1px solid #a5d6a7;
      }
      #status.error {
        color: #b71c1c;
        background: #ffebee;
        border: 1px solid #ffcdd2;
      }
      #loadingOverlay {
        position: fixed;
        inset: 0;
        background: rgba(255,255,255,0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
        font-size: 16px;
        color: #2e7d32;
      }
      .spinner {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: 5px solid #c8e6c9;
        border-top-color: #43a047;
        animation: spin 0.8s linear infinite;
        margin-bottom: 14px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      small {
        font-size: 12px;
        color: #607d8b;
      }
      .note {
        font-size: 13px;
        color: #455a64;
        margin-top: 6px;
      }
      .footer-note {
        margin-top: 16px;
        font-size: 12px;
        color: #78909c;
        text-align: center;
      }

      /* åœ°åŸŸæ›ã‘ç‡ï¼ˆI2 / J2ï¼‰å…¥åŠ›ã‚¨ãƒªã‚¢ */
      .rates-box {
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 10px;
        background: #ffffff;
        border: 1px solid #c5e1a5;
      }
      .rates-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 8px;
      }
      .rate-field {
        flex: 1;
        min-width: 220px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .rate-label {
        font-size: 14px;
        font-weight: bold;
        color: #2e7d32;
      }
      .rate-sub {
        font-size: 12px;
        color: #607d8b;
      }
      .rate-input-wrap {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .rate-input {
        flex: 1;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid #b0bec5;
        font-size: 14px;
      }
      .rate-input::placeholder {
        color: #b0bec5;
      }
      .rate-unit {
        font-size: 13px;
        color: #607d8b;
        white-space: nowrap;
      }
      .rates-status {
        font-size: 12px;
        margin-top: 4px;
      }
      .rates-status.ok {
        color: #1b5e20;
      }
      .rates-status.err {
        color: #b71c1c;
      }
    </style>
  </head>
  <body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div>å‡¦ç†ä¸­ã§ã™â€¦ï¼ˆæ•°ç§’ã€œåæ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰</div>
    </div>

    <div class="container">
      <!-- å³ä¸Šï¼šå…ƒã‚¹ãƒ—ã‚·ã‚’é–‹ããƒœã‚¿ãƒ³ -->
      <div class="top-right-btn">
        <button class="btn-small" id="openSheetBtn">
          <span>ğŸ“Š</span>
          <span>å…ƒã®ã‚¹ãƒ—ã‚·ãƒ‡ãƒ¼ã‚¿ã‚’é–‹ã</span>
        </button>
      </div>

      <h1>ãƒˆãƒªã‚±ã‚¢ â†’ ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰å¤‰æ›</h1>
      <div class="subtitle">
        â‘ ã€œâ‘¤ã®é †ç•ªã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ã§ã€è«‹æ±‚ç”¨CSVã‚’ä½œã‚Œã¾ã™ ğŸŒ¿
      </div>

      <!-- ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒˆãƒªã‚±ã‚¢ã§CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
      <div class="step">
        <div class="step-badge">1</div>
        <div class="step-content">
          <div class="step-title">ãƒˆãƒªã‚±ã‚¢ã‹ã‚‰CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</div>
          <p>
            ã¾ãšã€ãƒˆãƒªã‚±ã‚¢ã‚’é–‹ã„ã¦<br>
            ç”»é¢ä¸Šã§ <b>ã€Œã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨å®Ÿç¸¾ã€</b> ã®CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
          </p>
          <button class="btn btn-secondary" id="openTricareBtn">
            <span class="icon">ğŸ¥</span>
            <span>ãƒˆãƒªã‚±ã‚¢ï¼ˆTZAD010ï¼‰ã‚’é–‹ã</span>
          </button>
          <div class="note">
            ãƒˆãƒªã‚±ã‚¢ã€€ã€Œã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨å®Ÿç¸¾ã€ã®CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã“ã‚ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚
          </div>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒƒãƒ—2ï¼šåœ°åŸŸæ›ã‘ç‡ã‚’è¨­å®šã™ã‚‹ -->
      <div class="step">
        <div class="step-badge">2</div>
        <div class="step-content">
          <div class="step-title">åœ°åŸŸæ›ã‘ç‡ã‚’è¨­å®šã™ã‚‹</div>
          <p>
            ã‚·ãƒ¼ãƒˆã€Œè¨ˆç®—ãƒ‡ãƒ¼ã‚¿ã€ã®<br>
            <b>I2ï¼šæ‚£è€…è² æ‹…ç‡</b> ã¨ <b>J2ï¼šå‡¦é‡æ”¹å–„â…¡ç‡ï¼ˆ%ï¼‰</b> ã‚’ã“ã“ã§è¨­å®šã§ãã¾ã™ã€‚<br>
            ä½•ã‚‚å…¥ã£ã¦ã„ãªã„ã¨ãã¯ã€<b>I2 = 0.1 / J2 = 0</b> ã‚’è‡ªå‹•ã§ä½¿ã„ã¾ã™ã€‚
          </p>

          <div class="rates-box">
            <div class="rates-row">
              <div class="rate-field">
                <div class="rate-label">æ‚£è€…è² æ‹…ç‡ï¼ˆI2ï¼‰</div>
                <div class="rate-sub">ä¾‹ï¼š0.1 ãªã©ï¼ˆç©ºãªã‚‰ 0.1 ã‚’ä½¿ç”¨ï¼‰</div>
                <div class="rate-input-wrap">
                  <input
                    id="inputCoef"
                    type="number"
                    step="0.1"
                    class="rate-input"
                    placeholder="0.1"
                  >
                </div>
              </div>

              <div class="rate-field">
                <div class="rate-label">å‡¦é‡æ”¹å–„â…¡ç‡ï¼ˆJ2, %ï¼‰</div>
                <div class="rate-sub">ä¾‹ï¼š22.4 ãªã©ï¼ˆç©ºãªã‚‰ 0% ã‚’ä½¿ç”¨ï¼‰</div>
                <div class="rate-input-wrap">
                  <input
                    id="inputExtraRate"
                    type="number"
                    step="0.1"
                    class="rate-input"
                    placeholder="22.4"
                  >
                  <span class="rate-unit">%</span>
                </div>
              </div>
            </div>

            <button class="btn btn-secondary" id="saveRatesBtn">
              <span class="icon">ğŸ’¾</span>
              <span>è¨­å®šã‚’ä¿å­˜ã™ã‚‹</span>
            </button>
            <div id="ratesStatus" class="rates-status"></div>
          </div>

          <div class="note">
            ã€Œè¨­å®šã‚’ä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€ã‚·ãƒ¼ãƒˆã€Œè¨ˆç®—ãƒ‡ãƒ¼ã‚¿ã€ã® I2 / J2 ã«æ›¸ãè¾¼ã‚€ã ã‘ã§ã€è¨ˆç®—ã¯ã¾ã è¡Œã„ã¾ã›ã‚“ã€‚<br>
            ãã®ã‚ã¨ã€ã‚¹ãƒ†ãƒƒãƒ—â‘¢ã® CSV å–ã‚Šè¾¼ã¿ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒƒãƒ—3ï¼šCSVå–ã‚Šè¾¼ã¿ -->
      <div class="step">
        <div class="step-badge">3</div>
        <div class="step-content">
          <div class="step-title">ãƒˆãƒªã‚±ã‚¢ã®CSVã‚’ãˆã‚‰ã¶</div>
          <p>
            ã‚¹ãƒ†ãƒƒãƒ—â‘ ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ <b>ãƒˆãƒªã‚±ã‚¢ã®CSVãƒ•ã‚¡ã‚¤ãƒ«</b> ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>
            ãã®ã‚ã¨ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã‚·ãƒ¼ãƒˆã«å–ã‚Šè¾¼ã¿ â†’ è‡ªå‹•ã§è¨ˆç®—ã¾ã§è¡Œã„ã¾ã™ã€‚
          </p>
          <input type="file" id="fileInput" accept=".csv"><br>
          <button class="btn btn-primary" id="uploadBtn">
            <span class="icon">ğŸ“‚</span>
            <span>CSVã‚’å–ã‚Šè¾¼ã‚“ã§å¤‰æ›ã™ã‚‹</span>
          </button>
          <div class="note">
            â€» å–ã‚Šè¾¼ã‚€ã¨ã€Œãƒˆãƒªã‚±ã‚¢_CSVã€ã‚·ãƒ¼ãƒˆã®ä¸­èº«ã¯æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒƒãƒ—4ï¼šCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
      <div class="step">
        <div class="step-badge">4</div>
        <div class="step-content">
          <div class="step-title">ãƒãƒãƒ•ã‚©ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</div>
          <p>
            å¤‰æ›ãŒçµ‚ã‚ã£ãŸã‚‰ã€ã“ã®ãƒœã‚¿ãƒ³ã‹ã‚‰<br>
            <b>ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã«ã‚¢ãƒƒãƒ—ã™ã‚‹CSV</b> ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
          </p>
          <button class="btn btn-primary" id="downloadBtn">
            <span class="icon">â¬‡ï¸</span>
            <span>ãƒãƒãƒ•ã‚©ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
          </button><br>
          <small>ã‚·ãƒ¼ãƒˆã€Œãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã€ã®å†…å®¹ãŒãã®ã¾ã¾CSVã«ãªã‚Šã¾ã™ã€‚</small>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒƒãƒ—5ï¼šãƒãƒãƒ•ã‚©ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
      <div class="step">
        <div class="step-badge">5</div>
        <div class="step-content">
          <div class="step-title">ãƒãƒãƒ•ã‚©ã«CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</div>
          <p>
            ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã®è«‹æ±‚ç”»é¢ã‚’é–‹ãã€<br>
            ã‚¹ãƒ†ãƒƒãƒ—â‘£ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸCSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
          </p>
          <button class="btn btn-secondary" id="openMfBtn">
            <span class="icon">ğŸ’»</span>
            <span>ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ è«‹æ±‚ç”»é¢ã‚’é–‹ã</span>
          </button>
        </div>
      </div>

      <div id="status"></div>

      <div class="footer-note">
        è¿·ã£ãŸã¨ãã¯ã€â‘  â†’ â‘¡ â†’ â‘¢ â†’ â‘£ â†’ â‘¤ ã®é †ç•ªã ã‘æ„è­˜ã™ã‚Œã°OKã§ã™ ğŸ˜Š
      </div>
    </div>

    <script>
      const SPREADSHEET_URL = '<?= SPREADSHEET_URL ?>';
      const MF_URL = '<?= MF_URL ?>';
      const TRICARE_URL = '<?= TRICARE_URL ?>';

      const uploadBtn = document.getElementById('uploadBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const openSheetBtn = document.getElementById('openSheetBtn');
      const openMfBtn = document.getElementById('openMfBtn');
      const openTricareBtn = document.getElementById('openTricareBtn');
      const fileInput = document.getElementById('fileInput');
      const statusEl = document.getElementById('status');
      const loadingOverlay = document.getElementById('loadingOverlay');

      // åœ°åŸŸæ›ã‘ç‡ï¼ˆI2 / J2ï¼‰ã®å…¥åŠ›ç”¨
      const inputCoef = document.getElementById('inputCoef');
      const inputExtraRate = document.getElementById('inputExtraRate');
      const saveRatesBtn = document.getElementById('saveRatesBtn');
      const ratesStatusEl = document.getElementById('ratesStatus');

      function setButtonsDisabled(disabled) {
        [uploadBtn, downloadBtn, openSheetBtn, openMfBtn, openTricareBtn].forEach(btn => {
          if (btn) btn.disabled = disabled;
        });
      }

      function showLoading(show) {
        if (loadingOverlay) {
          loadingOverlay.style.display = show ? 'flex' : 'none';
        }
      }

      function setStatus(message, type) {
        if (!statusEl) return;
        statusEl.textContent = message || '';
        statusEl.className = '';
        if (type) statusEl.classList.add(type);
      }

      // I2 / J2 ã®ç¾åœ¨å€¤ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¦ã€ç”»é¢ã«åæ˜ 
      function loadRates() {
        if (!inputCoef || !inputExtraRate || !ratesStatusEl) return;

        ratesStatusEl.textContent = 'è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
        ratesStatusEl.className = 'rates-status';

        google.script.run
          .withSuccessHandler((res) => {
            if (res) {
              inputCoef.value = (res.coef !== undefined) ? res.coef : '';
              inputExtraRate.value = (res.extraRatePercent !== undefined) ? res.extraRatePercent : '';
            }
            ratesStatusEl.textContent = 'ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚';
            ratesStatusEl.classList.add('ok');
          })
          .withFailureHandler((err) => {
            console.error(err);
            const msg = err && err.message ? err.message : err;
            ratesStatusEl.textContent = 'è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + msg;
            ratesStatusEl.classList.add('err');
          })
          .getRatesForWeb();
      }

      // I2 / J2 ã‚’ã‚·ãƒ¼ãƒˆã«ä¿å­˜
      function saveRates() {
        if (!inputCoef || !inputExtraRate || !ratesStatusEl) return;

        let coefVal = inputCoef.value.trim();
        let extraVal = inputExtraRate.value.trim();

        // ç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ã†
        if (coefVal === '') coefVal = '0.1';
        if (extraVal === '') extraVal = '0';

        const coefNum = Number(coefVal);
        const extraNum = Number(extraVal);

        if (!Number.isFinite(coefNum)) {
          ratesStatusEl.textContent = 'æ‚£è€…è² æ‹…ç‡ï¼ˆI2ï¼‰ã¯æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          ratesStatusEl.className = 'rates-status err';
          return;
        }
        if (!Number.isFinite(extraNum)) {
          ratesStatusEl.textContent = 'å‡¦é‡æ”¹å–„â…¡ç‡ï¼ˆJ2, %ï¼‰ã¯æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          ratesStatusEl.className = 'rates-status err';
          return;
        }

        ratesStatusEl.textContent = 'è¨­å®šã‚’ä¿å­˜ä¸­ã§ã™â€¦';
        ratesStatusEl.className = 'rates-status';
        if (saveRatesBtn) saveRatesBtn.disabled = true;

        google.script.run
          .withSuccessHandler((res) => {
            if (saveRatesBtn) saveRatesBtn.disabled = false;
            ratesStatusEl.textContent =
              'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆæ‚£è€…è² æ‹…ç‡ï¼š' + res.coef +
              ' ï¼ å‡¦é‡æ”¹å–„â…¡ç‡ï¼š' + res.extraRatePercent + '%ï¼‰';
            ratesStatusEl.className = 'rates-status ok';
          })
          .withFailureHandler((err) => {
            if (saveRatesBtn) saveRatesBtn.disabled = false;
            console.error(err);
            const msg = err && err.message ? err.message : err;
            ratesStatusEl.textContent = 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + msg;
            ratesStatusEl.className = 'rates-status err';
          })
          .updateRatesFromWeb(coefNum, extraNum);
      }

      // CSVå–ã‚Šè¾¼ã¿ï¼‹å¤‰æ›ï¼ˆâ‘¢ï¼‰
      if (uploadBtn) {
        uploadBtn.addEventListener('click', () => {
          const file = fileInput && fileInput.files[0];
          if (!file) {
            alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
            return;
          }

          setButtonsDisabled(true);
          showLoading(true);
          setStatus('ãƒˆãƒªã‚±ã‚¢CSVã‚’å–ã‚Šè¾¼ã¿ä¸­ã§ã™â€¦', '');

          const reader = new FileReader();
          reader.onload = (e) => {
            const text = e.target.result;

            google.script.run
              .withSuccessHandler((result) => {
                showLoading(false);
                setButtonsDisabled(false);

                const rows = result && result.rowCount ? result.rowCount : '?';
                setStatus('å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆèª­ã¿è¾¼ã¿è¡Œæ•°ï¼š' + rows + ' è¡Œï¼‰', 'ok');
              })
              .withFailureHandler((err) => {
                showLoading(false);
                setButtonsDisabled(false);
                console.error(err);
                const msg = err && err.message ? err.message : err;
                setStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + msg, 'error');
              })
              .importCsvAndConvert(text);
          };

          reader.onerror = () => {
            showLoading(false);
            setButtonsDisabled(false);
            setStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
          };

          // ãƒˆãƒªã‚±ã‚¢ã®CSVã¯ Shift_JIS æƒ³å®šã§èª­ã¿è¾¼ã¿
          reader.readAsText(file, 'Shift_JIS');
        });
      }

      // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆâ‘£ï¼‰
      if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
          setButtonsDisabled(true);
          showLoading(true);
          setStatus('CSVã‚’æº–å‚™ä¸­ã§ã™â€¦', '');

          google.script.run
            .withSuccessHandler((result) => {
              showLoading(false);
              setButtonsDisabled(false);

              if (!result || !result.content) {
                setStatus('CSVãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                return;
              }

              const blob = new Blob([result.content], {
                type: 'text/csv;charset=UTF-8;'
              });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = result.filename || 'tricare_to_mf.csv';
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);

              setStatus('CSVã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'ok');
            })
            .withFailureHandler((err) => {
              showLoading(false);
              setButtonsDisabled(false);
              console.error(err);
              const msg = err && err.message ? err.message : err;
              setStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + msg, 'error');
            })
            .getProcessedCsv();
        });
      }

      // ã€Œè¨­å®šã‚’ä¿å­˜ã™ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆâ‘¡ï¼‰
      if (saveRatesBtn) {
        saveRatesBtn.addEventListener('click', saveRates);
      }

      // ãƒˆãƒªã‚±ã‚¢ã‚’é–‹ãï¼ˆâ‘ ï¼‰
      if (openTricareBtn) {
        openTricareBtn.addEventListener('click', () => {
          window.open(TRICARE_URL, '_blank');
        });
      }

      // ãƒãƒãƒ•ã‚©ã‚’é–‹ãï¼ˆâ‘¤ï¼‰
      if (openMfBtn) {
        openMfBtn.addEventListener('click', () => {
          window.open(MF_URL, '_blank');
        });
      }

      // å…ƒã‚¹ãƒ—ã‚·ã‚’é–‹ãï¼ˆå³ä¸Šï¼‰
      if (openSheetBtn) {
        openSheetBtn.addEventListener('click', () => {
          window.open(SPREADSHEET_URL, '_blank');
        });
      }

      // åˆæœŸè¡¨ç¤ºã®ã¨ãã« I2 / J2 ã‚’èª­ã¿è¾¼ã‚€
      window.addEventListener('load', () => {
        loadRates();
      });
    </script>
  </body>
</html>
